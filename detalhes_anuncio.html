<!DOCTYPE html>
<html>

<head>
  <!-- Basic -->
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <!-- Mobile Metas -->
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <!-- Site Metas -->
  <link rel="icon" href="images/favicon.ico" type="image/ico" />
  <meta name="keywords" content="" />
  <meta name="description" content="" />
  <meta name="author" content="" />

  <!-- nao salvar cache -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <title>Detalhes anúncio — Compartilhando Historias</title>

  <!-- bootstrap core css -->
  <link rel="stylesheet" href="css/bootstrap.css">
  <!-- font awesome style -->
  <link href="css/font-awesome.min.css" rel="stylesheet">
  <!-- Custom styles for this template -->
  <link href="css/style.css" rel="stylesheet">
  <!-- responsive style -->
  <link href="css/responsive.css" rel="stylesheet">

</head>

<body>

  <div class="hero_area">
    <!-- header section strats -->
    <header class="header_section">
      <nav class="navbar navbar-static-top navbar-expand-lg custom_nav-container ">
        <div class="container-fluid">

          <a class="navbar-brand" href="index.html">
            <img class="img-fluid" src="images/logo.svg" alt="logo">
          </a>

          <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class=""> </span>
          </button>

          <div class="collapse navbar-collapse" id="navbarSupportedContent">

            <form class="search_form" action="/search" method="get">
              <input type="text" id="str_q" class="form-control" name="q" placeholder="Buscar livro">
              <button class="search_icon" type="submit" id="send" disabled>
                <i class="fa fa-search" aria-hidden="true"></i>
              </button>
            </form>

            <ul class="navbar-nav">
              <li class="nav-item active">
                <a class="nav-link pl-lg-0" href="entrar.html">Entrar <span class="sr-only">(current)</span></a>
              </li>
            </ul>
            <div id="btn_sign" class="nav-item">
              <a class="btn-primary nav-link" href="cadastro.html">Cadastrar-se</a>
            </div>
          </div>
        </div>
      </nav>
    </header>
  </div>

  <section class="layout_padding" style="padding-left: 20px">



    <div style="text-align:center">
      
      <div style="font-weight: bold;font-size:32px" id="bookName"></div>

      <img width="30%" height="40%"
        class="capaLivro" src="./images/bookNoCover.png"
        alt="Capa"></div>

        <div class="row">
            <div style="width:9%; margin-left: 30%; auto;">
                 <img class="capaLivro" src="./images/bookNoCover.png" alt="Snow" style="width:100%">
            </div>
            <div style="width:9%; margin:10 auto;">
                <img class="capaLivro" src="./images/bookNoCover.png" alt="Forest" style="width:100%">
            </div>
            <div style="width:9%; margin:10 auto">
                <img class="capaLivro" src="./images/bookNoCover.png" alt="Mountains" style="width:100%">
            </div>
            <div style="width:9%; margin:10 auto;">
                <img class="capaLivro" src="./images/bookNoCover.png" alt="Mountains" style="width:100%">
            </div>
            <div style="width:9%; margin-right: 18%; auto;">
                <img class="capaLivro" src="./images/bookNoCover.png" alt="Mountains" style="width:100%">
            </div>
        </div>
        <div style="margin-right: 28%; text-align: right;">
            <i class="fa fa-star text-warning"></i><strong> Edição Especial</strong> 
            <strong><i class="fa fa-thumbs-up text-danger like-button"></i> 100</strong>  <a href="#"
            class="btn-sm btn-success ">Comprar</a>
      </div>

      <div id="comentarios"></div>

    <!-- <div style="margin-top:2%; margin-left: 15%"">
      <div class="clearfix">
        <div>
          <style>
            .orange-color {
              color: orange;
            }
          </style>

          <i class='fa fa-user-circle-o orange-color' style="font-size:50px;"></i>


        </div>
        <div>
          An introductory critical guide
          with five specialised essays analysing Melville's
          classic Moby-Dick.... An introductory critical guide <br>
          with five specialised essays analysing Melville's
          classic Moby-Dick....An introductory critical guide
          with five specialised essays analysing Melville's
          classic Moby-Dick....
        </div>
      </div>
  </div> -->

    <div class="container" style="margin-top:5%; ">
        <form action="/pagina-processa-dados-do-form" method="post">
            <div>
                <label for="nome">Escreva seu comentário:</label>
                <input type="text" id="nome" />
                <div> <a href="#" class="btn-sm btn-success" style="float: right; margin-top: 1%">Comentar</a>
              </div>
            </div>
        </form>
      </div>
  </section>

  <!-- end catagory section -->

  <!-- info section -->

  <section class="info_section layout_padding2">
    <div class="container">
      <div class="row">
        <div class="col-md-8 info-col">
          <div class="info_detail">
            <h4>
              Sobre
            </h4>
            <p>
              Desenvolvido pelos alunos do curso de Sistemas de Informação da PUC Minas, referente ao projeto de
              Aplicações Web.
            </p>
            <div class="info_social">
              <a href="">
                <i class="fa fa-github" aria-hidden="true"></i>
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- end info section -->

  <!-- footer section -->
  <footer class="footer_section">
    <div class="container">
      <p>
        &copy; <span id="displayYear"></span> Compartilhando Historias
      </p>
    </div>
  </footer>
  <!-- footer section -->

  <script>
  async function run(id) {


    /// primeiro passo: conectar ao Valdeir Mendes passando o id e pegar o book_id do google
    let resposta1 = await fetch(`http://anybook.valdeirmendes.com:3000/anuncios`)
    let json1 = await resposta1.json()


    let book_id;
    let comentarios = [];

    // filtra o JSON para pegar o book_id do id
    json1.forEach(item => {
      if (item.id == id) {
        book_id = item.book_id;
      }
    })

    // terceiro passo: pega os comentários do livro
    let resposta2 = await fetch(`http://anybook.valdeirmendes.com:3000/comentarios`)
    let json2 = await resposta2.json()


    // conectar a API trazendo o usuário que fez este comentário
    let resposta3 = await fetch(`http://anybook.valdeirmendes.com:3000/usuarios`)
    let json3 = await resposta3.json()


    // filtra o JSON para pegar os comentários deste anuncio
    json2.forEach(item => {
      console.log("item ->", item)
      if (item.ad_id == id) {
       
        let newComment = {
          comentario: item.comment,
          user: item.user_id
        }
        
        comentarios.push(newComment)
      }
    })

        // mostra comentários
        let htmlFinal = "";

        comentarios.forEach(item => {          


          let nomeComentador = "";

          // filtra o usuario para encontrar o item do usuario
          json3.forEach(usuario => {

            if (usuario.id == item.user) {
              nomeComentador = usuario.nome              
            }
          })

          let html = `<div style="margin-top:2%; margin-left: 15%"">
                  <div class="clearfix">
                    <div>
                      <style>
                        .orange-color {
                          color: orange;
                        }
                      </style>
                      <i class='fa fa-user-circle-o orange-color' style="font-size:50px;"></i>
                      <b>${nomeComentador}</b>
                    </div>
                    <div>
                      ${item.comentario} 
                    </div>
                  </div>
                </div>`

                htmlFinal = htmlFinal + html
 
          })

          document.getElementById("comentarios").innerHTML = htmlFinal
 

    // segundo passo: conectar ao google API e pegar o endereço da capa

    let resposta = await fetch(`https://www.googleapis.com/books/v1/volumes/${book_id}?key=AIzaSyBhTmP67mrRHyCfeW50fx1nTBwUIZFxTf8`)
    let respostaJson = await resposta.json()
    // pego a informação do link da imagem da capa
    let imgValue = respostaJson.volumeInfo.imageLinks.thumbnail
    let nomeLivro = respostaJson.volumeInfo.title

    document.getElementById("bookName").innerHTML = `<a href='/detalhes_livro.html?${book_id}'>${nomeLivro}</a>`

    console.log(imgValue)

    // pego o elemento que vai exibir a imagem da capa
    let elementoImg = document.getElementsByClassName("capaLivro")

    Array.from(elementoImg).forEach((el) => {
    // Do stuff here
      el.src = imgValue;
    });

    // altero a propriedade src do elemento para o endereço da imagem da capa
    elementoImg.src = imgValue

    console.log("comentarios ", comentarios)


  }


  const queryString = window.location.search;
  let idBook = queryString.slice(4, queryString.length)
  console.log(idBook)
  run(idBook)

</script>

  </script>
</body>
</html>